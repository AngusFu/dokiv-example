#!/usr/bin/env node
const path = require('path')
const http = require('http')
const fs = require('fs-extra')
const globby = require('globby')
const yaml = require('js-yaml')
const request = require('request-promise')

const bundle = require('../lib/bundle')
const compileVue = require('../lib/md2vue')
const getMetadata = require('../lib/metadata')
const createSsrServer = require('../lib/server')

const cwd = process.cwd()
const spinner = require('ora')('Loading unicorns')
const configFile = path.resolve(cwd, './vmdoc.yml')

if (fs.existsSync(configFile) === false) {
  spinner.warn('vmdoc.yml not found under current working directory!')
  return
}

const config = yaml.safeLoad(fs.readFileSync(configFile, 'utf8'))
const outputDirectory = path.resolve(cwd, config.output)
const routerMode = config.mode

buildFromLocale(config)
  .catch(e => {
    console.log(e)
  })
  .then(() => {
    process.exit()  
  })

async function buildFromLocale ({
  title = 'vmDoc', 
  links = [],
  groups = [],
  docs = []
}) {
  spinner.start('Building task starts...')

  const categories = groups.map(group => group.name)

  // name -> text(title)
  const cateMap = groups.reduce((acc, { text, name }) => {
    acc[name] = text
    return acc
  }, {})

  // group -> page[]
  const pageMap = await traversFiles({
    glob: docs,
    categories
  })

  const routers = []
  const sideNavs = []
  const urls = []

  for (let cateName of categories) {
    const cateList = []

    for (let page of pageMap[cateName]) {
      if (page) {
        const { component, path, title } = page

        if (routers.length === 0) {
          urls.push('/')
          routers.push(`{ path: "/", redirect: "${path}" }`)
        }

        urls.push(path)
        cateList.push({ title, path })
        routers.push(`{ path: "${path}", component: (${component}) }`)
      }
    }

    sideNavs.push({
      // group title
      text: cateMap[cateName],
      // info of detail pages
      pages: cateList
    })
  }

  routers.push(`{ path: "*", redirect: "/" }`)

  const initialState = {
    links,
    groups: sideNavs
  }

  const template = await fs.readFile(
    abs('../template/app.html'),
    'utf-8'
  )

  const {
    clientSource,
    serverSource
  } = bundle({
    template,
    routers,
    routerMode,
    initialState
  })

  await fs.emptyDir(outputDirectory)
  await fs.ensureDir(path.join(outputDirectory, 'assets'))
  await fs.writeFile(`${outputDirectory}/assets/pageInfo.js`, clientSource)
  await fs.copy(abs('../template/index.html'), `${outputDirectory}/index.html`)
  await fs.copy(abs('../dist/bundle.js'), path.join(outputDirectory, 'assets/bundle.js'))
  await fs.copy(abs('../dist/bundle.css'), path.join(outputDirectory, 'assets/bundle.css'))

  spinner.succeed('Building task completed!')

  if (routerMode === 'history') {
    await fs.writeFile(`${outputDirectory}/ssr.js`, serverSource)

    spinner.start('Bootsrap ssr server...')

    createSsrServer({
      ssrConfig: require(path.join(outputDirectory, 'ssr.js')),
      staticDirectory: outputDirectory
    })

    for (let url of urls) {
      spinner.info(`Start server-rendering ${url}`)
      const resp = await request(`http://127.0.0.1:1126${url}`)
      const dest = path.join(outputDirectory, `${url}/index.html`)
      await fs.createFile(dest)
      await fs.writeFile(dest, resp)
      spinner.succeed(`Done server-rendering ${url}`)
    }

    await fs.remove(`${outputDirectory}/ssr.js`)
    spinner.succeed('SSR rendering completed!')
    spinner.succeed(`Documents can be found here: ${outputDirectory}`)
  }
}

async function traversFiles ({
  glob,
  categories
}) {
  const map = {}

  for (file of await globby(glob)) {
    const {
      route,
      index,
      title,
      markdown,
      category,
      componentName
    } = await getMetadata(file)

    // category not specified
    if (!category) {
      spinner.warn(`Skip ${file}: group not specified!`)
      continue
    }

    // category not listed in config file
    if (categories.includes(category) === false) {
      spinner.warn(
        `Skip ${file}: group \`${category}\` is not included ` +
        `in configuration!`
      )
      continue
    }

    const component = await compileVue({ markdown, componentName, title })

    map[category] = map[category] || []
    map[category][index] = {
      title,
      component,
      path: route
    }
  }

  return map
}

/**
 * absolute path to this file
 */
function abs (arg) {
  return path.resolve(__dirname, arg)
}
